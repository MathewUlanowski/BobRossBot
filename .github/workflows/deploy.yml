name: Deploy (production)

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Publish Docker Images"]
    types: [completed]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  deploy:
    name: Build, push image and deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine registry and tag
        id: setvars
        run: |
          if [ -n "${{ secrets.REGISTRY_URL }}" ]; then
            echo "REGISTRY=${{ secrets.REGISTRY_URL }}" >> $GITHUB_ENV
            echo "HAS_REGISTRY=true" >> $GITHUB_ENV
            echo "IMAGE=${{ secrets.REGISTRY_URL }}/bobrossbot" >> $GITHUB_ENV
          else
            # fallback to GHCR when no registry specified
            REG_LOWER=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
            echo "IMAGE=ghcr.io/${REG_LOWER}" >> $GITHUB_ENV
            echo "HAS_REGISTRY=false" >> $GITHUB_ENV
          fi
          # deterministic tag: short sha on main, otherwise run id
          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
            echo "IMAGE_TAG=latest" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=v${GITHUB_RUN_ID}" >> $GITHUB_ENV
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to registry (only if credentials present)
        if: ${{ secrets.REGISTRY_URL && secrets.DOCKER_USERNAME && secrets.DOCKER_PASSWORD }}
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.REGISTRY_URL }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and optionally push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile
          push: ${{ secrets.REGISTRY_URL && secrets.DOCKER_USERNAME && secrets.DOCKER_PASSWORD }}
          tags: ${{ env.IMAGE }}:${{ env.IMAGE_TAG }}
          target: runtime

      - name: Set up Helm & kubectl
        uses: azure/setup-helm@v1

      - name: Helm lint (inline)
        run: helm lint ./helm

      - name: Helm template (render only) and verify probes/resources (inline)
        run: |
          out=$(mktemp)
          helm template ./helm --values ./helm/values.yaml > "$out"
          if ! grep -q "readinessProbe:" "$out"; then
            echo "ERROR: rendered templates missing readinessProbe"
            cat "$out"
            exit 2
          fi
          if ! grep -q "livenessProbe:" "$out"; then
            echo "ERROR: rendered templates missing livenessProbe"
            cat "$out"
            exit 3
          fi
          if ! grep -q "resources:" "$out"; then
            echo "ERROR: rendered templates missing resources"
            cat "$out"
            exit 4
          fi
          echo "Helm template verification passed: probes and resources present"

      - name: Configure kubeconfig (if provided)
        run: |
          if [ -n "${{ secrets.KUBE_CONFIG }}" ]; then
            echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig
            echo "Kubeconfig written to $PWD/kubeconfig"
            export KUBECONFIG=$PWD/kubeconfig
          else
            echo "KUBE_CONFIG secret not set; skipping kubeconfig setup"
          fi

      - name: Deploy Helm chart to cluster (if kubeconfig present)
        run: |
          if [ -n "${{ secrets.KUBE_CONFIG }}" ]; then
            export KUBECONFIG=$PWD/kubeconfig
            helm upgrade --install bobrossbot ./helm \
              --namespace bobrossbot --create-namespace \
              --set image.repository=${{ env.IMAGE }} \
              --set image.tag=${{ env.IMAGE_TAG }} \
              --atomic --wait --timeout 5m
            # Wait for deployments to roll out
            kubectl rollout status deployment -l app=bobrossbot -n bobrossbot --timeout=3m
          else
            echo "KUBE_CONFIG secret not set; skipping Helm deploy"
            exit 0
          fi

