name: Deploy

on:
  workflow_run:
    workflows: ["build-pipeline"]
    types: [completed]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Override image tag at manual dispatch'
        required: false
      helm_values:
        description: 'Path to values file (e.g., helm/values.prod.yaml)'
        required: false
      helm_set:
        description: 'Additional --set overrides (e.g., image.pullPolicy=IfNotPresent)'
        required: false

permissions:
  contents: read
  packages: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  # Required repository variables (set these in Repo Settings → Variables)
  REGISTRY_URL: ${{ vars.REGISTRY_URL }}
  REGISTRY_USERNAME: ${{ vars.REGISTRY_USERNAME }}
  REGISTRY_PASSWORD: ${{ vars.REGISTRY_PASSWORD }}
  KUBE_CONFIG_B64: ${{ vars.KUBE_CONFIG_B64 }}
  # Optional repository variables to control which image and k8s target to deploy
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}    # e.g. myorg/bobrossbot
  IMAGE_TAG: ${{ vars.IMAGE_TAG }}      # if not set, will fallback to the build pipeline's tag or commit
  K8S_NAMESPACE: ${{ vars.K8S_NAMESPACE }}
  K8S_DEPLOYMENT: ${{ vars.K8S_DEPLOYMENT }}
  K8S_CONTAINER_NAME: ${{ vars.K8S_CONTAINER_NAME }}
  # Optional Helm options
  HELM_RELEASE: ${{ vars.HELM_RELEASE }}
  HELM_EXTRA_ARGS: ${{ vars.HELM_EXTRA_ARGS }}

jobs:
  deploy:
    # Run either when build-pipeline completed successfully, or when manually dispatched
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.REGISTRY_URL || secrets.REGISTRY_URL || 'ghcr.io' }}
          username: ${{ vars.REGISTRY_USERNAME || secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Deploy via Helm Action
        uses: deliverybot/helm@v1
        with:
          release: ${{ vars.HELM_RELEASE || vars.K8S_DEPLOYMENT || github.repository }}
          namespace: ${{ vars.K8S_NAMESPACE || 'default' }}
          chart: ./helm
          values: |
            image:
              repository: ${{ vars.REGISTRY_URL || secrets.REGISTRY_URL }}/{{ vars.IMAGE_NAME }}
              tag: ${{ github.event.inputs.image_tag || vars.IMAGE_TAG || github.event.workflow_run.head_sha || 'latest' }}
          value-files: '["./helm/values.yaml"]'
          token: ${{ github.token }}
        env:
          KUBECONFIG_FILE: ${{ secrets.KUBECONFIG }}

      - name: Success
        run: echo "Helm deploy succeeded ✅"
