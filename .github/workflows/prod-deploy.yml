name: Production Deploy (manual)

on:
  workflow_dispatch:
    inputs:
      image_repo:
        description: 'Image repository (e.g., ghcr.io/org/bobrossbot)'
        required: true
      image_tag:
        description: 'Image tag to deploy (e.g., sha or latest)'
        required: true
      namespace:
        description: 'Kubernetes namespace to deploy to'
        required: false
        default: 'bobrossbot'

jobs:
  preflight:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          REGISTRY_URL: ${{ secrets.REGISTRY_URL }}
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
        run: |
          missing=""
          for name in KUBE_CONFIG DISCORD_TOKEN OPENAI_API_KEY; do
            if [ -z "${!name}" ]; then
              missing="$missing $name"
            fi
          done
          if [ -n "$missing" ]; then
            echo "Missing required secrets:$missing"
            exit 1
          fi
          if ([ -n "${REGISTRY_USERNAME}" ] && [ -z "${REGISTRY_PASSWORD}" ]) || ([ -n "${REGISTRY_PASSWORD}" ] && [ -z "${REGISTRY_USERNAME}" ]); then
            echo "REGISTRY_USERNAME and REGISTRY_PASSWORD must both be set if one is provided"
            exit 1
          fi
          echo "Secrets check passed"

  deploy:
    needs: preflight
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure kubeconfig
        run: |
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig
          mkdir -p $HOME/.kube
          mv kubeconfig $HOME/.kube/config

      - name: Ensure namespace
        run: |
          kubectl create namespace ${{ github.event.inputs.namespace }} || true

      - name: Create Docker registry pull secret (if needed)
        if: ${{ secrets.REGISTRY_USERNAME && secrets.REGISTRY_PASSWORD }}
        run: |
          kubectl delete secret regcred -n ${{ github.event.inputs.namespace }} || true
          kubectl create secret docker-registry regcred \
            --docker-server=${{ secrets.REGISTRY_URL }} \
            --docker-username=${{ secrets.REGISTRY_USERNAME }} \
            --docker-password=${{ secrets.REGISTRY_PASSWORD }} \
            -n ${{ github.event.inputs.namespace }}

      - name: Create application secrets
        run: |
          kubectl delete secret bobrossbot-secrets -n ${{ github.event.inputs.namespace }} || true
          kubectl create secret generic bobrossbot-secrets \
            --from-literal=DISCORD_TOKEN="${{ secrets.DISCORD_TOKEN }}" \
            --from-literal=OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            -n ${{ github.event.inputs.namespace }}

      - name: Deploy with Helm
        run: |
          chmod +x ./scripts/deploy-helm.sh
          ./scripts/deploy-helm.sh "${{ github.event.inputs.namespace }}" "bobrossbot" "${{ github.event.inputs.image_repo }}" "${{ github.event.inputs.image_tag }}"
