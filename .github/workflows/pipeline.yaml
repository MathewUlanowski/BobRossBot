name: Build & Deploy Pipeline

on:
  pull_request:
    branches: ["*"]
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  # Required repository variables (set these in Repo Settings → Variables)
  REGISTRY_URL: ${{ vars.REGISTRY_URL }}
  REGISTRY_USERNAME: ${{ vars.REGISTRY_USERNAME }}
  REGISTRY_PASSWORD: ${{ vars.REGISTRY_PASSWORD }}
  KUBE_CONFIG_B64: ${{ vars.KUBE_CONFIG_B64 }}
  # Optional repository variables to control which image and k8s target to deploy
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}    # e.g. myorg/bobrossbot
  IMAGE_TAG: ${{ vars.IMAGE_TAG }}      # if not set, will fallback to the build pipeline's tag or commit
  K8S_NAMESPACE: ${{ vars.K8S_NAMESPACE }}
  K8S_DEPLOYMENT: ${{ vars.K8S_DEPLOYMENT }}
  K8S_CONTAINER_NAME: ${{ vars.K8S_CONTAINER_NAME }}
  # Optional Helm options
  HELM_RELEASE: ${{ vars.HELM_RELEASE }}
  HELM_EXTRA_ARGS: ${{ vars.HELM_EXTRA_ARGS }}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - id: meta
        name: Docker metadata
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=sha
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Log in to GHCR
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build (and push on main/tags)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Set image tag output
        id: set-tag
        run: |
          echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main')

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.REGISTRY_URL || secrets.REGISTRY_URL || 'ghcr.io' }}
          username: ${{ vars.REGISTRY_USERNAME || secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Install kubectl and helm
        run: |
          set -eux
          # Install kubectl
          KUBECTL_VERSION=$(curl -L -s https://dl.k8s.io/release/stable.txt)
          curl -LO "https://dl.k8s.io/release/$KUBECTL_VERSION/bin/linux/amd64/kubectl"
          install -m 0755 kubectl /usr/local/bin/kubectl

          # Install helm
          HELM_VERSION=v3.12.0
          curl -LO "https://get.helm.sh/helm-$HELM_VERSION-linux-amd64.tar.gz"
          tar xzf "helm-$HELM_VERSION-linux-amd64.tar.gz"
          install -m 0755 linux-amd64/helm /usr/local/bin/helm

      - name: Write kubeconfig
        env:
          KUBECONFIG_SECRET: ${{ vars.KUBE_CONFIG_B64 || secrets.KUBECONFIG || '' }}
        run: |
          set -eux
          # If KUBECONFIG_SECRET is base64, decode; else write as-is
          if echo "$KUBECONFIG_SECRET" | base64 --decode >/tmp/kubeconfig 2>/dev/null; then
            echo "Decoded base64 kubeconfig"
          else
            echo "$KUBECONFIG_SECRET" > /tmp/kubeconfig
          fi
          export KUBECONFIG=/tmp/kubeconfig
          kubectl version --client

      - name: Helm upgrade
        env:
          RELEASE: ${{ vars.HELM_RELEASE || vars.K8S_DEPLOYMENT || github.repository }}
          NS: ${{ vars.K8S_NAMESPACE || 'default' }}
          IMAGE_REGISTRY: ${{ vars.REGISTRY_URL || secrets.REGISTRY_URL }}
          IMAGE_NAME: ${{ vars.IMAGE_NAME }}
          TAG: ${{ github.event.inputs.image_tag || vars.IMAGE_TAG || needs.build.outputs.image_tag || 'latest' }}
          HELM_EXTRA_ARGS: ${{ vars.HELM_EXTRA_ARGS || '' }}
        run: |
          set -eux
          IMAGE_REPO="${IMAGE_REGISTRY}/${IMAGE_NAME}"
          helm upgrade --install "$RELEASE" ./helm --namespace "$NS" --create-namespace --set image.repository="$IMAGE_REPO" --set image.tag="$TAG" $HELM_EXTRA_ARGS || (helm status "$RELEASE" --namespace "$NS" && exit 1)

      - name: Success
        run: echo "Helm deploy succeeded ✅"
